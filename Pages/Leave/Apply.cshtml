@page "/Leave/Apply"
@model ApplyModel
@{
    ViewData["Title"] = "Apply for Leave";
}

<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Index">Dashboard</a></li>
                <li class="breadcrumb-item active">Apply for Leave</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
<div class="col-lg-8">
    <!-- Calendar View Card -->
    <div class="card mb-2" id="calendarCard">
        <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Leave Calendar
                </h5>
                <div class="btn-group btn-group-sm" role="group" aria-label="View toggle">
                    <button type="button" class="btn btn-outline-secondary active" id="viewMonth">Month</button>
                    <button type="button" class="btn btn-outline-secondary" id="viewYear">Year</button>
                </div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Density">
                    <button type="button" class="btn btn-outline-secondary" id="densityComfortable">Comfort</button>
                    <button type="button" class="btn btn-outline-secondary" id="densityCompact">Compact</button>
                    <button type="button" class="btn btn-outline-secondary active" id="densityUltra">Ultra</button>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Month navigation">
                    <button type="button" class="btn btn-outline-primary" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="currentMonth">Today</button>
                    <button type="button" class="btn btn-outline-primary" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Year navigation">
                    <button type="button" class="btn btn-outline-dark" id="prevYear">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <span class="fw-semibold small px-2" id="yearNavLabel"></span>
                    <button type="button" class="btn btn-outline-dark" id="nextYear">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="leaveCalendar" class="leave-calendar"></div>
                
            <!-- Calendar Legend -->
            <div class="calendar-legend mt-2">
                <div class="row g-2">
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-working"></span>
                            Working Day
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-weekend"></span>
                            Weekend
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-holiday"></span>
                            Public Holiday
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-approved"></span>
                            Approved Leave
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-pending"></span>
                            Pending Leave
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-rejected"></span>
                            Rejected Leave
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-cancelled"></span>
                            Cancelled Leave
                        </span>
                    </div>
                    <div class="col-auto">
                        <span class="legend-item">
                            <span class="legend-color bg-selected"></span>
                            Selected Range
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <div class="card" id="applyFormCard">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-plus-circle me-2"></i>Apply for Leave
            </h4>
        </div>
        <div class="card-body">
                <form method="post" id="leaveApplicationForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    @if (Model.LineManager != null)
                    {
                        <div class="alert alert-success mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-tie fa-2x me-3"></i>
                                <div>
                                    <h6 class="mb-0">Your Line Manager</h6>
                                    <strong>@Model.LineManager.FullName</strong>
                                    <br><small class="text-muted">This leave application will be sent to your line manager for approval</small>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                <div>
                                    <h6 class="mb-0">No Line Manager Assigned</h6>
                                    <small>You don't have a line manager assigned. Please contact HR before applying for leave.</small>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label asp-for="Input.LeaveTypeId" class="form-label">Leave Type</label>
                            <select asp-for="Input.LeaveTypeId" class="form-select" id="leaveTypeSelect">
                                <option value="">Select leave type...</option>
                                @foreach (var leaveType in Model.LeaveTypes)
                                {
                                    <option value="@leaveType.LeaveTypeId" 
                                            data-requires-approval="@leaveType.RequiresApproval.ToString().ToLower()"
                                            data-is-paid="@leaveType.IsPaid.ToString().ToLower()"
                                            data-description="@leaveType.Description">
                                        @leaveType.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="Input.LeaveTypeId" class="text-danger"></span>
                            <div id="leaveTypeInfo" class="form-text"></div>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Available Balance</label>
                            <div id="availableBalance" class="form-control-plaintext fw-bold">
                                Select a leave type to see balance
                            </div>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label asp-for="Input.StartDate" class="form-label">Start Date</label>
                            <input asp-for="Input.StartDate" class="form-control" type="date" id="startDate" />
                            <span asp-validation-for="Input.StartDate" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label asp-for="Input.EndDate" class="form-label">End Date</label>
                            <input asp-for="Input.EndDate" class="form-control" type="date" id="endDate" />
                            <span asp-validation-for="Input.EndDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-2">
                            <div class="alert alert-success" id="leaveDaysInfo" style="display: none;">
                                <span id="leaveDaysText"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label asp-for="Input.Reason" class="form-label">Reason for Leave</label>
                        <textarea asp-for="Input.Reason" class="form-control" rows="3" 
                                  placeholder="Please provide details about your leave request..."></textarea>
                        <span asp-validation-for="Input.Reason" class="text-danger"></span>
                    </div>

                    <div class="mb-2">
                        <label asp-for="Input.ContactDuringLeave" class="form-label">Emergency Contact During Leave (Optional)</label>
                        <input asp-for="Input.ContactDuringLeave" class="form-control" 
                               placeholder="Phone number or email for emergencies" />
                        <span asp-validation-for="Input.ContactDuringLeave" class="text-danger"></span>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success" id="submitButton">
                            <i class="fas fa-paper-plane me-2"></i>Submit Application
                        </button>
                        <a asp-page="/Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Leave Balances Sidebar -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Your Leave Balances
                </h5>
            </div>
            <div class="card-body">
                @if (Model.LeaveBalances.Any())
                {
                    @foreach (var balance in Model.LeaveBalances)
                    {
                        <div class="mb-3 p-3 border rounded" data-leave-type-id="@balance.LeaveTypeId">
                            <div class="d-flex justify-content-between mb-1">
                                <strong>@balance.LeaveType?.Name</strong>
                                <span class="badge bg-success">@balance.AvailableDays days</span>
                            </div>
                            <div class="small text-muted">
                                Total: @balance.TotalDays | Used: @balance.UsedDays | Pending: @balance.PendingDays
                            </div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: @((balance.TotalDays > 0 ? (balance.AvailableDays / balance.TotalDays * 100) : 0))%"></div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p class="mb-0">No leave balances found</p>
                        <small>Contact HR to set up your leave entitlements</small>
                    </div>
                }
            </div>
        </div>

        <!-- Leave Policies -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>Leave Policies & Holidays
                </h5>
            </div>
            <div class="card-body">
                @if (Model.LineManager != null)
                {
                    <div class="alert alert-info">
                        <h6><i class="fas fa-user-tie me-2"></i>Your Line Manager</h6>
                        <p class="mb-0">
                            <strong>@Model.LineManager.FullName</strong><br />
                            <small class="text-muted">Leave applications will be sent to your line manager for approval.</small>
                        </p>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>No Line Manager Assigned</h6>
                        <p class="mb-0">
                            <small>You don't have a line manager assigned. Please contact HR before applying for leave.</small>
                        </p>
                    </div>
                }

                <h6 class="text-primary">BCEA Requirements:</h6>
                <ul class="list-unstyled small mb-3">
                    <li class="mb-2">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                        Leave requests should be submitted at least 3 days in advance
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        Annual leave requires manager approval
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-medical-bag text-success me-2"></i>
                        Sick leave: 6 months eligibility, medical certificate may be required
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-ban text-warning me-2"></i>
                        Weekends and public holidays excluded from calculations
                    </li>
                </ul>
                
                <h6 class="text-success"><i class="fas fa-flag me-1"></i> SA Public Holidays @DateTime.Now.Year:</h6>
                <div class="small">
                    <div class="row">
                        <div class="col-6">
                            <ul class="list-unstyled mb-0">
                                <li><i class="fas fa-flag text-success me-2"></i> Jan 1 - New Year's Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Mar 21 - Human Rights Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Apr 27 - Freedom Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> May 1 - Workers' Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Jun 16 - Youth Day</li>
                            </ul>
                        </div>
                        <div class="col-6">
                            <ul class="list-unstyled mb-0">
                                <li><i class="fas fa-flag text-success me-2"></i> Aug 9 - Women's Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Sep 24 - Heritage Day</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Dec 16 - Reconciliation</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Dec 25 - Christmas</li>
                                <li><i class="fas fa-flag text-success me-2"></i> Dec 26 - Day of Goodwill</li>
                            </ul>
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i> Easter holidays vary each year. System automatically excludes all public holidays.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<link rel="stylesheet" href="~/css/leave-calendar.css" />
    <style>
        /* Compact spacing tweaks for this page */
        #applyFormCard .card-body { padding: 0.7rem 0.85rem; }
        #calendarCard .card-body { padding: 0.5rem 0.5rem; }
        #calendarCard .btn-group .btn { padding: .2rem .5rem; }
        label.form-label { margin-bottom: .15rem; }
        .form-control, .form-select { padding: .3rem .5rem; }
        .badge { font-size: .65rem; }
        .progress { height: 5px; }
        /* Ultra mode extras */
        .density-ultra #leaveCalendar { margin-top: 0; }
        .density-ultra .calendar-day:hover { transform: none; box-shadow: none; }
    </style>
    
<script>
// Leave balances data
const leaveBalances = @Html.Raw(Json.Serialize(Model.LeaveBalances.ToDictionary(lb => lb.LeaveTypeId, lb => new { lb.AvailableDays, lb.TotalDays })));
        
    // Existing leave for calendar visualization (all statuses)
    const existingLeave = @Html.Raw(Json.Serialize(ViewData["ExistingLeaveApplications"] ?? new List<object>()));
    // Approved/Pending only for overlap blocking
    const blockingLeave = @Html.Raw(Json.Serialize(ViewData["BlockingLeaveApplications"] ?? new List<object>()));
        
// Public holidays data
const publicHolidays = @Html.Raw(Json.Serialize(ViewData["PublicHolidays"] ?? new List<object>()));

// Debug: Log calendar data
console.log('?? Calendar Data Loaded:');
console.log('Public Holidays:', publicHolidays);
    console.log('Existing Leave (calendar):', existingLeave);
    console.log('Blocking Leave (overlap):', blockingLeave);
console.log('Leave Balances:', leaveBalances);

// Calendar state
let currentCalendarMonth = new Date();
    let selectedStartDate = null;
    let selectedEndDate = null;
    let isSelectingRange = false;
    let viewMode = 'month'; // 'month' or 'year'
    let selectedYear = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize calendar
        render();

        // Density toggle
        const calendarCard = document.getElementById('calendarCard');
        const densityCompactBtn = document.getElementById('densityCompact');
        const densityComfortBtn = document.getElementById('densityComfortable');
        const densityUltraBtn = document.getElementById('densityUltra');
        function setDensity(mode) {
            calendarCard.classList.remove('density-compact', 'density-ultra');
            densityCompactBtn.classList.remove('active');
            densityComfortBtn.classList.remove('active');
            densityUltraBtn.classList.remove('active');
            if (mode === 'ultra') {
                calendarCard.classList.add('density-ultra');
                densityUltraBtn.classList.add('active');
            } else if (mode === 'compact') {
                calendarCard.classList.add('density-compact');
                densityCompactBtn.classList.add('active');
            } else {
                densityComfortBtn.classList.add('active');
            }
        }
        densityUltraBtn.addEventListener('click', () => setDensity('ultra'));
        densityCompactBtn.addEventListener('click', () => setDensity('compact'));
        densityComfortBtn.addEventListener('click', () => setDensity('comfort'));
        setDensity('ultra');
            
        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            if (viewMode === 'month') {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            } else {
                currentCalendarMonth.setFullYear(currentCalendarMonth.getFullYear() - 1);
                selectedYear = currentCalendarMonth.getFullYear();
            }
            render();
        });
            
        document.getElementById('nextMonth').addEventListener('click', () => {
            if (viewMode === 'month') {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
            } else {
                currentCalendarMonth.setFullYear(currentCalendarMonth.getFullYear() + 1);
                selectedYear = currentCalendarMonth.getFullYear();
            }
            render();
        });
            
        document.getElementById('currentMonth').addEventListener('click', () => {
            currentCalendarMonth = new Date();
            selectedYear = currentCalendarMonth.getFullYear();
            render();
        });

        // Year navigation
        document.getElementById('prevYear').addEventListener('click', () => {
            selectedYear--;
            currentCalendarMonth.setFullYear(selectedYear);
            render();
        });

        document.getElementById('nextYear').addEventListener('click', () => {
            selectedYear++;
            currentCalendarMonth.setFullYear(selectedYear);
            render();
        });

        // Toggle Month/Year view
        document.getElementById('viewMonth').addEventListener('click', () => {
            viewMode = 'month';
            document.getElementById('viewMonth').classList.add('active');
            document.getElementById('viewYear').classList.remove('active');
            render();
        });
        document.getElementById('viewYear').addEventListener('click', () => {
            viewMode = 'year';
            document.getElementById('viewYear').classList.add('active');
            document.getElementById('viewMonth').classList.remove('active');
            selectedYear = currentCalendarMonth.getFullYear();
            render();
        });
            const leaveTypeSelect = document.getElementById('leaveTypeSelect');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const availableBalance = document.getElementById('availableBalance');
            const leaveTypeInfo = document.getElementById('leaveTypeInfo');
            const leaveDaysInfo = document.getElementById('leaveDaysInfo');
            const leaveDaysText = document.getElementById('leaveDaysText');
            
            // Sync calendar with date inputs
            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    selectedStartDate = new Date(this.value);
                    render();
                }
            });
            
            endDateInput.addEventListener('change', function() {
                if (this.value) {
                    selectedEndDate = new Date(this.value);
                    render();
                }
            });

            // Update balance display when leave type changes
            leaveTypeSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const leaveTypeId = parseInt(this.value);
                
                if (leaveTypeId && leaveBalances[leaveTypeId]) {
                    const balance = leaveBalances[leaveTypeId];
                    availableBalance.innerHTML = `<span class="text-success">${balance.availableDays} days available</span>`;
                    
                    // Show leave type info
                    const requiresApproval = selectedOption.getAttribute('data-requires-approval') === 'true';
                    const isPaid = selectedOption.getAttribute('data-is-paid') === 'true';
                    const description = selectedOption.getAttribute('data-description');
                    
                    let infoHtml = description + '<br>';
                    infoHtml += `<small class="text-muted">`;
                    infoHtml += `${isPaid ? 'Paid' : 'Unpaid'} leave`;
                    infoHtml += requiresApproval ? ' - Requires approval' : ' - No approval required';
                    infoHtml += `</small>`;
                    
                    leaveTypeInfo.innerHTML = infoHtml;
                } else {
                    availableBalance.textContent = 'Select a leave type to see balance';
                    leaveTypeInfo.textContent = '';
                }
                
                calculateLeaveDays();
            });

            // Calculate leave days when dates change
            startDateInput.addEventListener('change', calculateLeaveDays);
            endDateInput.addEventListener('change', calculateLeaveDays);

            function calculateLeaveDays() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (startDate && endDate && startDate <= endDate) {
                    // Check for overlapping leave first
                    const overlappingLeave = checkForOverlappingLeave(startDate, endDate);
                    if (overlappingLeave) {
                        leaveDaysInfo.className = 'alert alert-danger';
                        leaveDaysText.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Overlapping leave detected! You already have ${overlappingLeave.Status.toLowerCase()} leave from ${overlappingLeave.StartDate} to ${overlappingLeave.EndDate}.`;
                        leaveDaysInfo.style.display = 'block';
                        return;
                    }
                    
                    let totalDays = 0;
                    let currentDate = new Date(startDate);
                    
                    while (currentDate <= endDate) {
                        // Skip weekends
                        if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                            totalDays++;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    if (totalDays > 0) {
                        // Default to success style and message
                        let messageHtml = `<i class="fas fa-check-circle me-2"></i>Total leave days: ${totalDays} (excluding weekends)`;
                        let alertClass = 'alert alert-success';

                        // Check if sufficient balance
                        const leaveTypeId = parseInt(leaveTypeSelect.value);
                        if (leaveTypeId && leaveBalances[leaveTypeId]) {
                            const balance = leaveBalances[leaveTypeId];
                            if (totalDays > balance.availableDays) {
                                alertClass = 'alert alert-warning';
                                messageHtml = `<i class=\"fas fa-exclamation-triangle me-2\"></i>Total leave days: ${totalDays} - Warning: Exceeds available balance (${balance.availableDays} days)`;
                            }
                        }

                        leaveDaysInfo.className = alertClass;
                        leaveDaysText.innerHTML = messageHtml;
                        leaveDaysInfo.style.display = 'block';
                    } else {
                        leaveDaysInfo.style.display = 'none';
                    }
                } else {
                    leaveDaysInfo.style.display = 'none';
                }
            }

            function checkForOverlappingLeave(startDate, endDate) {
                for (let leave of blockingLeave) {
                    // Support both PascalCase and camelCase JSON (System.Text.Json uses camelCase by default)
                    const leaveStart = new Date(leave.StartDate ?? leave.startDate);
                    const leaveEnd = new Date(leave.EndDate ?? leave.endDate);
                    const status = leave.Status ?? leave.status;
                    
                    // Check for any overlap
                    if ((startDate >= leaveStart && startDate <= leaveEnd) ||
                        (endDate >= leaveStart && endDate <= leaveEnd) ||
                        (startDate <= leaveStart && endDate >= leaveEnd)) {
                        return {
                            StartDate: leaveStart.toLocaleDateString(),
                            EndDate: leaveEnd.toLocaleDateString(),
                            Status: status
                        };
                    }
                }
                return null;
            }

            // Update end date minimum when start date changes
            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    endDateInput.min = this.value;
                    if (endDateInput.value && endDateInput.value < this.value) {
                        endDateInput.value = this.value;
                    }
                }
            });

            // Prevent double submission and validate
            const form = document.getElementById('leaveApplicationForm');
            const submitButton = document.getElementById('submitButton');
            
            form.addEventListener('submit', function(e) {
                // Check for overlaps before submitting
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (startDate && endDate) {
                    const overlappingLeave = checkForOverlappingLeave(startDate, endDate);
                    if (overlappingLeave) {
                        e.preventDefault();
                        alert(`Cannot submit: You already have ${overlappingLeave.Status.toLowerCase()} leave from ${overlappingLeave.StartDate} to ${overlappingLeave.EndDate}.`);
                        return false;
                    }
                }
                
                // Disable submit button and show loading state (keep success theme)
                submitButton.disabled = true;
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-success');
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
                
                // Re-enable after 5 seconds as failsafe (in case of error)
                setTimeout(function() {
                    if (submitButton.disabled) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class=\"fas fa-paper-plane me-2\"></i>Submit Application';
                    }
                }, 5000);
            });
        });
        
        // Calendar rendering functions
        function renderCalendar() {
            const calendarContainer = document.getElementById('leaveCalendar');
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
            
            let html = `
                <div class="calendar-header">
                    <div class="calendar-month-year">
                        ${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                    </div>
                </div>
                <div class="calendar-grid">
            `;
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const prevMonthDate = new Date(year, month, -(startingDayOfWeek - i - 1));
                html += renderDay(prevMonthDate, true);
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                html += renderDay(date, false);
            }
            
            // Fill remaining cells with next month days
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                const nextMonthDate = new Date(year, month + 1, i);
                html += renderDay(nextMonthDate, true);
            }
            
            html += '</div>';
            calendarContainer.innerHTML = html;
            
            // Add click handlers to calendar days
            document.querySelectorAll('.calendar-day:not(.other-month):not(.disabled)').forEach(dayEl => {
                dayEl.addEventListener('click', function() {
                    const dateStr = this.dataset.date;
                    handleDateClick(new Date(dateStr));
                });
            });
        }
        
        function renderDay(date, isOtherMonth) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateStr = formatDate(date);
            const dayOfWeek = date.getDay();
            
            let classes = ['calendar-day'];
            let label = '';
            let tooltip = '';
            
            if (isOtherMonth) {
                classes.push('other-month');
            }
            
            // Check if today
            if (date.toDateString() === today.toDateString()) {
                classes.push('today');
            }
            
            // Check for public holiday (support PascalCase and camelCase JSON)
            const holiday = publicHolidays.find(h => (h.Date ?? h.date) === dateStr);
            if (holiday) {
                classes.push('holiday');
                const holidayName = holiday.Name ?? holiday.name;
                label = holidayName;
                tooltip = holidayName;
            }
            // Check for existing leave
            else {
                const leave = getLeaveForDate(date);
                if (leave) {
                    const status = (leave.Status ?? leave.status);
                    if (status === 'Approved') {
                        classes.push('approved');
                        label = 'Approved';
                        tooltip = 'Approved Leave';
                    } else if (status === 'Pending') {
                        classes.push('pending');
                        label = 'Pending';
                        tooltip = 'Pending Leave';
                    } else if (status === 'Rejected') {
                        classes.push('rejected');
                        label = 'Rejected';
                        tooltip = 'Rejected Leave';
                    } else if (status === 'Cancelled') {
                        classes.push('cancelled');
                        label = 'Cancelled';
                        tooltip = 'Cancelled Leave';
                    }
                }
                // Check if weekend
                else if (dayOfWeek === 0 || dayOfWeek === 6) {
                    classes.push('weekend');
                    label = 'Weekend';
                }
                // Working day
                else if (!isOtherMonth) {
                    classes.push('working');
                }
            }
            
            // Check if in selected range
            if (selectedStartDate && selectedEndDate) {
                const startTime = selectedStartDate.getTime();
                const endTime = selectedEndDate.getTime();
                const currentTime = date.getTime();
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    classes.push('selected');
                    if (currentTime === startTime) {
                        classes.push('range-start');
                    }
                    if (currentTime === endTime) {
                        classes.push('range-end');
                    }
                    if (currentTime > startTime && currentTime < endTime) {
                        classes.push('range-middle');
                    }
                }
            } else if (selectedStartDate && date.getTime() === selectedStartDate.getTime()) {
                classes.push('selected');
            }
            
            const tooltipAttr = tooltip ? `data-tooltip="${tooltip}"` : '';
            
            return `
                <div class="${classes.join(' ')}" data-date="${dateStr}" ${tooltipAttr}>
                    <div class="calendar-day-number">${date.getDate()}</div>
                    ${label ? `<div class="calendar-day-label">${label}</div>` : ''}
                </div>
            `;
        }
        
        function handleDateClick(date) {
            if (!isSelectingRange) {
                // First click - set start date
                selectedStartDate = date;
                selectedEndDate = null;
                isSelectingRange = true;
                
                // Update input
                document.getElementById('startDate').value = formatDate(date);
                document.getElementById('endDate').value = formatDate(date);
            } else {
                // Second click - set end date
                if (date < selectedStartDate) {
                    // If clicked date is before start, swap them
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = date;
                } else {
                    selectedEndDate = date;
                }
                isSelectingRange = false;
                
                // Update inputs
                document.getElementById('startDate').value = formatDate(selectedStartDate);
                document.getElementById('endDate').value = formatDate(selectedEndDate);
                
                // Trigger calculation
                calculateLeaveDays();
            }
            
            render();
        }
        
        function getLeaveForDate(date) {
            const dateStr = formatDate(date);
            // If multiple records cover the same day, pick by precedence: Approved > Pending > Rejected > Cancelled
            let match = null;
            let precedence = { Approved: 4, Pending: 3, Rejected: 2, Cancelled: 1 };
            for (const leave of existingLeave) {
                const start = new Date(leave.StartDate ?? leave.startDate);
                const end = new Date(leave.EndDate ?? leave.endDate);
                if (isNaN(start) || isNaN(end)) continue;
                const startStr = formatDate(start);
                const endStr = formatDate(end);
                if (dateStr >= startStr && dateStr <= endStr) {
                    const s = (leave.Status ?? leave.status) || '';
                    if (!match || (precedence[s] ?? 0) > (precedence[match.Status ?? match.status] ?? 0)) {
                        match = leave;
                    }
                }
            }
            return match;
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function render() {
            // Update year label in header
            const yearLabel = document.getElementById('yearNavLabel');
            if (yearLabel) {
                yearLabel.textContent = viewMode === 'year' ? selectedYear : currentCalendarMonth.getFullYear();
            }
            if (viewMode === 'month') {
                renderCalendar();
            } else {
                renderYearCalendar(selectedYear);
            }
        }

        function renderYearCalendar(year) {
            const calendarContainer = document.getElementById('leaveCalendar');
            let html = `<div class="calendar-multi-month">`;
            for (let m = 0; m < 12; m++) {
                html += renderMonthBlock(year, m);
            }
            html += `</div>`;
            calendarContainer.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.calendar-day:not(.other-month):not(.disabled)').forEach(dayEl => {
                dayEl.addEventListener('click', function() {
                    const dateStr = this.dataset.date;
                    handleDateClick(new Date(dateStr));
                });
            });
        }

        function renderMonthBlock(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            let html = `
                <div class="leave-calendar border rounded p-2">
                    <div class="calendar-header"><div class="calendar-month-year">${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div></div>
                    <div class="calendar-grid">
            `;

            // headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // leading blanks
            const startingDayOfWeek = firstDay.getDay();
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += `<div></div>`;
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                html += renderDay(date, false);
            }

            html += `</div></div>`;
            return html;
        }
    </script>
}